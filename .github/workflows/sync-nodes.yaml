name: Sync V2Ray Nodes

on:
  schedule:
    # Run every hour (adjust if needed)
    - cron: '0 */1 * * *'
  workflow_dispatch:
    # Allow manual trigger and optional override of source repository
    inputs:
      source_repo:
        description: 'Source repository in owner/repo format (overrides repository secret SOURCE_REPO)'
        required: false
        default: ''

jobs:
  sync-nodes:
    runs-on: ubuntu-latest

    # Compute the SOURCE_REPO used by the job:
    # - If triggered via workflow_dispatch with input `source_repo`, that value is used
    # - Otherwise the repository secret SOURCE_REPO is used
    env:
      SOURCE_REPO: ${{ github.event.inputs.source_repo != '' && github.event.inputs.source_repo || secrets.SOURCE_REPO }}

    steps:
    - name: Ensure SOURCE_REPO is provided
      run: |
        if [ -z "$SOURCE_REPO" ]; then
          echo "ERROR: SOURCE_REPO is not set. Provide it via the workflow_dispatch input 'source_repo' or set the repository secret 'SOURCE_REPO'."
          exit 1
        fi
        echo "Using SOURCE_REPO=$SOURCE_REPO"

    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        repository: dongd-wang/nodes
        token: ${{ secrets.PAT_TOKEN }}
        path: target-repo

    - name: Checkout source repository (from env SOURCE_REPO)
      uses: actions/checkout@v4
      with:
        repository: ${{ env.SOURCE_REPO }}
        path: source-repo

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Extract and process content
      run: |
        cd source-repo
        ls .
        
        # Create a temporary file to store all content
        echo "# V2Ray Free Nodes - $(date)" > ../temp_nodes.txt
        echo "" >> ../temp_nodes.txt
        
        # Process all files in current directory only (no subdirectories, no hidden files)
        find . -maxdepth 1 -type f ! -name ".*" ! -name "*README*" ! -name "*readme*" | while read file; do
          # Skip the current directory indicator
          if [ "$file" = "." ]; then
            continue
          fi
          
          if [ -f "$file" ] && [ -s "$file" ]; then
            echo "## Content from: $file" >> ../temp_nodes.txt
            echo "" >> ../temp_nodes.txt
            cat "$file" >> ../temp_nodes.txt
            echo "" >> ../temp_nodes.txt
            echo "---" >> ../temp_nodes.txt
            echo "" >> ../temp_nodes.txt
          fi
        done
        
        # Also include any subscription links or node configurations
        if [ -f "clash.yaml" ]; then
          echo "## Clash Configuration" >> ../temp_nodes.txt
          echo "" >> ../temp_nodes.txt
          cat clash.yaml >> ../temp_nodes.txt
          echo "" >> ../temp_nodes.txt
        fi
        
        if [ -f "v2ray.txt" ]; then
          echo "## V2Ray Configurations" >> ../temp_nodes.txt
          echo "" >> ../temp_nodes.txt
          cat v2ray.txt >> ../temp_nodes.txt
          echo "" >> ../temp_nodes.txt
        fi
        
        # Look for any files with node configurations (current directory only)
        # Only include content from the single most-recently modified matching file.
        newest=""
        newest_mtime=0
        # Use find -print0 to handle filenames with spaces/newlines
        while IFS= read -r -d '' file; do
          # Skip hidden/readme files already filtered by find
          if [ -f "$file" ] && [ -s "$file" ]; then
            if grep -Eq "vmess|vless|trojan|ss://" "$file"; then
              mtime=$(stat -c %Y "$file" 2>/dev/null || stat -f %m "$file" 2>/dev/null)
              # Ensure mtime is numeric
              if [ -n "$mtime" ] && [ "$mtime" -gt "$newest_mtime" ]; then
                newest_mtime=$mtime
                newest="$file"
              fi
            fi
          fi
        done < <(find . -maxdepth 1 -type f ! -name ".*" ! -name "*README*" ! -name "*readme*" -print0 2>/dev/null)

        if [ -n "$newest" ]; then
          echo "## Node configurations from: $newest" >> ../temp_nodes.txt
          echo "" >> ../temp_nodes.txt
          cat "$newest" >> ../temp_nodes.txt
          echo "" >> ../temp_nodes.txt
          echo "---" >> ../temp_nodes.txt
          echo "" >> ../temp_nodes.txt
        else
          echo "No node configuration files found matching patterns." >> ../temp_nodes.txt
          echo "" >> ../temp_nodes.txt
        fi

    - name: Update nodes file
      run: |
        cd target-repo
        
        # Copy the processed content to the nodes file
        cp ../temp_nodes.txt nodes
        
        # Add timestamp and source information
        echo "" >> nodes

    - name: Commit and push changes
      run: |
        cd target-repo
        
        # Configure git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Check if there are changes
        if git diff --quiet nodes; then
          echo "No changes detected"
          exit 0
        fi
        
        # Add and commit changes
        git add nodes
        git commit -m "Auto-sync nodes  - $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        
        # Push changes
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}

    - name: Clean up
      run: |
        rm -f ../temp_nodes.txt || true
